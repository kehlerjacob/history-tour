<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historic Landmark Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .leaflet-container {
            font-family: 'Inter', sans-serif;
        }
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #a5b4fc; 
            border-radius: 2px;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-indigo-600 shadow-xl z-50 p-4 flex flex-col md:flex-row items-center justify-between gap-4 flex-none">
        <div>
            <h1 class="text-2xl font-bold text-white">Historic Places Explorer</h1>
            <p class="text-indigo-200 text-sm">Official National Register Data (NPS)</p>
        </div>

        <div class="bg-indigo-700 rounded-lg p-3 flex items-center gap-4 w-full md:w-auto">
            <label for="radiusSlider" class="text-white text-sm font-medium whitespace-nowrap">Search Radius:</label>
            <input type="range" id="radiusSlider" min="1" max="20" step="1" value="3" class="w-full md:w-48">
            <span id="radiusValue" class="text-white font-bold text-sm w-16 text-right">3 mi</span>
        </div>
    </header>

    <!-- Map Container -->
    <!-- Removed relative/z-0 to let Leaflet handle stacking context naturally -->
    <div id="map" class="flex-1 w-full bg-gray-200"></div>

    <!-- Location Status -->
    <div id="locationStatus" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 rounded-full shadow-lg z-[1000] flex items-center gap-2 transition-opacity duration-500 opacity-0 pointer-events-none">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-sm font-medium text-gray-700" id="locationStatusText">Locating...</span>
    </div>

    <!-- Landmark Details Card -->
    <div id="detailsCard" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[2000] hidden flex items-center justify-center p-4" onclick="closeCard()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md md:max-w-lg lg:max-w-2xl overflow-hidden transform transition-all duration-300 scale-100" onclick="event.stopPropagation()">
            <!-- Card Header -->
            <div class="p-5 border-b border-gray-100 flex justify-between items-start bg-indigo-50">
                <div>
                    <h2 id="cardTitle" class="text-xl md:text-2xl font-extrabold text-gray-800">Landmark Details</h2>
                    <p id="cardRefNum" class="text-sm text-indigo-500 font-medium mt-1"></p>
                </div>
                <button onclick="closeCard()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Card Body -->
            <div class="p-5 max-h-[70vh] overflow-y-auto">
                <div id="cardContent" class="space-y-6">
                    
                    <!-- Official Data Section -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Official Registry Data</h3>
                        <div class="grid grid-cols-1 gap-y-4">
                            <div>
                                <p class="text-xs text-gray-500">Listed Date</p>
                                <p id="dataListed" class="text-sm font-semibold text-gray-800">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Location</p>
                                <p id="dataLocation" class="text-sm font-semibold text-gray-800">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">NPS Reference Number</p>
                                <p id="dataRef" class="text-sm font-semibold text-gray-800 font-mono">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                         <a id="npsLink" href="#" target="_blank" class="inline-flex items-center justify-center w-full px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition">
                            View on National Park Service Gallery
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                        <p class="text-xs text-gray-400 mt-2">Opens the official scanned documents in a new tab.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;

        // App State
        let map = null;
        // Default to Washington D.C. (National Mall)
        let currentLat = 38.8893; 
        let currentLng = -77.0502;
        let currentRadiusMiles = 3; // Increased default radius
        let markersLayerGroup = null;
        let userLocationMarker = null;
        
        const landmarksStore = {};

        // --- FIREBASE SETUP ---
        function initializeFirebase() {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                            else await signInAnonymously(auth);
                        } catch (e) { console.error(e); }
                    }
                });
            }
        }

        // --- GEOLOCATION & NPS API UTILS ---

        function updateStatus(msg, isError = false) {
            const el = document.getElementById('locationStatus');
            const text = document.getElementById('locationStatusText');
            const dot = el.querySelector('div');
            
            text.textContent = msg;
            el.classList.remove('opacity-0');
            
            if (isError) {
                dot.classList.remove('bg-green-500', 'animate-pulse');
                dot.classList.add('bg-red-500');
            } else {
                dot.classList.remove('bg-red-500');
                dot.classList.add('bg-green-500', 'animate-pulse');
            }

            setTimeout(() => { el.classList.add('opacity-0'); }, 4000);
        }

        // MOVED DEFINITION: Defining addUserMarker before it is called by getUserLocation
        function addUserMarker() {
            if (!map) return;
            if (userLocationMarker) map.removeLayer(userLocationMarker);
            
            const userIcon = window.L.divIcon({
                className: 'bg-blue-600 border-2 border-white rounded-full shadow-xl',
                iconSize: [16, 16],
                html: ''
            });
            
            userLocationMarker = window.L.marker([currentLat, currentLng], {icon: userIcon})
                .addTo(map)
                .bindPopup("You are here")
                .openPopup();
        }

        function getUserLocation() {
            if (!navigator.geolocation) {
                updateStatus("Geolocation not supported", true);
                if (map) fetchNearbyLandmarks(); 
                return;
            }
            
            updateStatus("Finding location...");
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    updateStatus("Location found!");
                    
                    if (map) {
                        map.setView([currentLat, currentLng], 14);
                        addUserMarker(); 
                        fetchNearbyLandmarks();
                    }
                },
                (error) => {
                    // Geolocation error captured here, falling back to D.C.
                    console.error("Location error:", error);
                    updateStatus("Location denied. Using Default (D.C.)", true);
                    if (map) fetchNearbyLandmarks(); 
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function getBoundingBox(lat, lng, radiusMiles) {
            const latChange = radiusMiles / 69.0;
            const lngChange = radiusMiles / (69.0 * Math.cos(lat * Math.PI / 180));
            
            // CRITICAL FIX: Rounding coordinates to 6 decimal places to prevent ArcGIS server parsing errors (400 Bad Request)
            const precision = 6; 
            
            return {
                xmin: (lng - lngChange).toFixed(precision),
                ymin: (lat - latChange).toFixed(precision),
                xmax: (lng + lngChange).toFixed(precision),
                ymax: (lat + latChange).toFixed(precision)
            };
        }

        async function fetchNearbyLandmarks() {
            if (!map) return;
            
            updateStatus(`Searching within ${currentRadiusMiles} mile(s)...`);

            const bbox = getBoundingBox(currentLat, currentLng, currentRadiusMiles);
            // Format: xmin,ymin,xmax,ymax (Lng, Lat, Lng, Lat)
            const bboxString = `${bbox.xmin},${bbox.ymin},${bbox.xmax},${bbox.ymax}`;
            
            const baseUrl = "https://mapservices.nps.gov/arcgis/rest/services/cultural_resources/nrhp_locations/MapServer/0/query";
            
            // Ensure we ask for GeoJSON with the correct spatial reference (WGS84 = 4326)
            const params = new URLSearchParams({
                where: "1=1", 
                geometry: bboxString,
                geometryType: "esriGeometryEnvelope",
                spatialRel: "esriSpatialRelIntersects",
                inSR: "4326",
                outSR: "4326", 
                outFields: "RESNAME,NRIS_Refnum,LISTED_DATE,ADDRESS,CITY,STATE",
                returnGeometry: "true",
                f: "geojson", 
                resultRecordCount: "100" // Limit to 100 to avoid overload
            });

            const url = `${baseUrl}?${params.toString()}`;
            console.log("Querying NPS API (Cleaned BBOX):", url); 

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("NPS API detailed error:", errorData);
                    throw new Error(`NPS API request failed with status ${response.status}. Message: ${errorData.error.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    displayLandmarks(data.features);
                    updateStatus(`Found ${data.features.length} sites`);
                } else {
                    console.warn("No features returned:", data);
                    updateStatus("No historic sites found nearby", true);
                    if (markersLayerGroup) markersLayerGroup.clearLayers();
                }
            } catch (error) {
                console.error("Error fetching landmarks:", error);
                updateStatus("Error connecting to NPS database or query rejected.", true);
            }
        }

        function displayLandmarks(features) {
            if (!map) return;
            
            // Re-initialize layer group if missing
            if (!markersLayerGroup) {
                markersLayerGroup = window.L.layerGroup().addTo(map);
            } else {
                markersLayerGroup.clearLayers();
            }

            // Icon styling with hardcoded colors
            const historicIcon = window.L.divIcon({
                className: 'bg-transparent',
                html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="#4f46e5" stroke="#ffffff" stroke-width="2" style="filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.3));"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm0 8.625a1.125 1.125 0 100 2.25 1.125 1.125 0 000-2.25zM15.375 12a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM7.5 10.5a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5zm10.5-1.5a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5z" clip-rule="evenodd" /></svg>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            features.forEach(feature => {
                // Safety check for geometry
                if (!feature.geometry || !feature.geometry.coordinates) return;

                const coords = feature.geometry.coordinates;
                const props = feature.properties;
                
                const id = props.NRIS_Refnum || Math.random().toString(36).substr(2, 9);
                landmarksStore[id] = props;

                // GeoJSON is [lng, lat]
                const lat = coords[1];
                const lng = coords[0];
                const name = props.RESNAME || "Historic Site";

                const marker = window.L.marker([lat, lng], { icon: historicIcon })
                    .bindPopup(
                        `<div class="text-center p-2">
                            <h4 class="font-bold text-indigo-700 mb-2 text-sm">${name}</h4>
                            <button class="block w-full text-xs text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-2 rounded shadow transition font-medium" 
                                onclick="openCard('${id}')">
                                View Details
                            </button>
                        </div>`
                    );
                
                markersLayerGroup.addLayer(marker);
            });
        }

        // --- MAP INITIALIZATION ---

        function initMap() {
            if (map) return;
            
            // Polling check for Leaflet
            if (typeof window.L === 'undefined' || !window.L.map) {
                setTimeout(initMap, 100);
                return;
            }

            if (!document.getElementById('map')) return;

            map = window.L.map('map').setView([currentLat, currentLng], 14);
            map.invalidateSize();

            // CartoDB Positron (Simplified map style)
            window.L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 19
            }).addTo(map);

            markersLayerGroup = window.L.layerGroup().addTo(map);

            // Start location search
            getUserLocation();

            setTimeout(() => map.invalidateSize(), 250);
        }

        // --- UI INTERACTIONS ---

        const slider = document.getElementById('radiusSlider');
        const radiusLabel = document.getElementById('radiusValue');

        slider.addEventListener('input', (e) => {
            currentRadiusMiles = e.target.value;
            radiusLabel.textContent = `${currentRadiusMiles} mi`;
        });

        slider.addEventListener('change', () => {
            fetchNearbyLandmarks();
        });

        // --- CARD LOGIC ---

        window.openCard = function(id) {
            const data = landmarksStore[id];
            if (!data) return;

            const card = document.getElementById('detailsCard');
            
            document.getElementById('cardTitle').textContent = data.RESNAME || "Unknown Name";
            document.getElementById('cardRefNum').textContent = `Reference #: ${data.NRIS_Refnum}`;
            
            let dateStr = "Unknown";
            if (data.LISTED_DATE) {
                const dateObj = new Date(data.LISTED_DATE);
                if (!isNaN(dateObj)) dateStr = dateObj.toLocaleDateString();
                else dateStr = data.LISTED_DATE;
            }
            document.getElementById('dataListed').textContent = dateStr;
            
            const city = data.CITY || "";
            const state = data.STATE || "";
            document.getElementById('dataLocation').textContent = `${city}${city && state ? ', ' : ''}${state}`;
            
            document.getElementById('dataRef').textContent = data.NRIS_Refnum;

            const linkBtn = document.getElementById('npsLink');
            if (data.NRIS_Refnum) {
                linkBtn.href = `https://npgallery.nps.gov/AssetDetail/NRIS/${data.NRIS_Refnum}`;
                linkBtn.classList.remove('hidden');
            } else {
                linkBtn.classList.add('hidden');
            }

            card.classList.remove('hidden');
        }

        window.closeCard = function() {
            document.getElementById('detailsCard').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
        
        // Ensure map tries to load
        if (document.readyState === "complete" || document.readyState === "interactive") {
            setTimeout(initMap, 100);
        } else {
            document.addEventListener("DOMContentLoaded", initMap);
        }

    </script>
</body>
</html>

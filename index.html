<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Compass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using Inter font for better readability */
        :root { font-family: 'Inter', sans-serif; }
        /* Keyframes for a smooth pointer update effect */
        .compass-pointer {
            transition: transform 0.1s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-sm bg-gray-800 p-6 rounded-xl shadow-2xl flex flex-col items-center">
        <h1 class="text-3xl font-bold mb-4 text-emerald-400">Digital Compass</h1>

        <!-- Status and Enable Button -->
        <div id="status-area" class="w-full mb-6 flex justify-center">
            <button id="enable-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 shadow-md">
                Enable Compass
            </button>
            <p id="status-message" class="hidden text-sm text-center text-red-400 p-2 rounded-lg bg-gray-700/50 w-full">
                Waiting for permission...
            </p>
        </div>

        <!-- Compass Display -->
        <div class="relative w-64 h-64 mb-6">
            <!-- Compass Rose (Background) -->
            <div class="absolute inset-0 rounded-full bg-gray-900 border-8 border-gray-700 shadow-inner flex items-center justify-center">
                <!-- Cardinal Points -->
                <div class="absolute top-0 w-2 h-4 bg-red-500 rounded-b-full"></div>
                <span class="absolute top-4 text-xl font-bold text-red-500">N</span>
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-lg text-gray-400">E</span>
                <span class="absolute bottom-4 text-lg text-gray-400">S</span>
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-lg text-gray-400">W</span>
            </div>

            <!-- Compass Pointer (Needle) -->
            <div id="compass-pointer" class="compass-pointer absolute inset-0 flex items-center justify-center transform rotate-0">
                <div class="w-0 h-0 border-l-[10px] border-r-[10px] border-b-[100px] border-l-transparent border-r-transparent border-b-red-500 transform -translate-y-1/2 absolute top-1/2" style="transform-origin: 50% 100%;"></div>
                <div class="w-4 h-4 rounded-full bg-gray-200 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 border-2 border-gray-700"></div>
                <div class="w-0 h-0 border-l-[10px] border-r-[10px] border-b-[100px] border-l-transparent border-r-transparent border-b-gray-400 rotate-180 transform -translate-y-1/2 absolute top-1/2" style="transform-origin: 50% 100%;"></div>
            </div>
        </div>

        <!-- Heading Display -->
        <div class="flex flex-col items-center">
            <p class="text-4xl font-extrabold text-white mb-1">
                <span id="heading-value">N/A</span>Â°
            </p>
            <p id="cardinal-direction" class="text-xl font-semibold text-emerald-300">
                Waiting...
            </p>
        </div>

    </div>

    <script type="text/javascript">
        // Helper to convert degree to Cardinal direction
        function degToCard(deg) {
            if (deg === null) return 'N/A';
            const val = Math.floor((deg / 22.5) + 0.5);
            const arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
            return arr[(val % 16)];
        }

        // Main logic to handle the DeviceOrientation event
        function handleOrientation(event) {
            let magneticHeading = null;

            // 1. Check for webkitCompassHeading (preferred, often more accurate on iOS Safari)
            if (event.webkitCompassHeading !== undefined && event.webkitCompassHeading !== null) {
                // webkitCompassHeading gives the magnetic North in degrees (0 to 360)
                // We want 0 degrees to be North, so we use the value directly.
                magneticHeading = event.webkitCompassHeading;
            }
            // 2. Fallback to standard alpha (needs adjustment based on screen orientation)
            else if (event.alpha !== undefined && event.alpha !== null) {
                let alpha = event.alpha;
                let screenOrientation = window.orientation || 0; // 0, 90, -90, 180

                // Adjust the alpha value based on device orientation (landscape vs portrait)
                // The 'alpha' value is the rotation relative to the phone's top edge
                // when the phone is flat (usually 0 is North).
                
                // For a compass, we typically want the rotation to be relative to the North pole (0 degrees).
                // The 'alpha' angle is usually the rotation around the Z-axis, with 0 being North.
                // However, the compass pointer needs to rotate by 360 - heading value (to point North).
                // And sometimes, we need to correct for screen orientation (window.orientation).

                // The standard approach is:
                // Heading = 360 - (alpha + screenOrientation) % 360
                magneticHeading = 360 - alpha - screenOrientation;

                // Normalize the heading to be between 0 and 360
                magneticHeading = (magneticHeading + 360) % 360;
            }

            if (magneticHeading !== null) {
                // Update the visual pointer rotation (we rotate the pointer 360 - heading so the pointer tip points North)
                const pointerRotation = 360 - magneticHeading;
                document.getElementById('compass-pointer').style.transform = `rotate(${pointerRotation}deg)`;

                // Update the text display
                document.getElementById('heading-value').textContent = Math.round(magneticHeading);
                document.getElementById('cardinal-direction').textContent = degToCard(magneticHeading);
            }
        }

        // Function to request permissions and start compass updates
        async function enableCompass() {
            const enableButton = document.getElementById('enable-button');
            const statusMessage = document.getElementById('status-message');
            
            enableButton.disabled = true;

            try {
                // Check if DeviceOrientationEvent is supported
                if (window.DeviceOrientationEvent) {
                    // Check for the modern permission API (required on iOS 13+)
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permissionState = await DeviceOrientationEvent.requestPermission();
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            enableButton.classList.add('hidden');
                            statusMessage.textContent = 'Compass Active.';
                            statusMessage.classList.remove('text-red-400', 'hidden');
                            statusMessage.classList.add('text-green-400');
                        } else {
                            statusMessage.textContent = 'Permission denied.';
                            statusMessage.classList.remove('hidden');
                            enableButton.disabled = false;
                        }
                    } else {
                        // Standard Device Orientation API (older Android/iOS or non-Safari)
                        window.addEventListener('deviceorientation', handleOrientation);
                        enableButton.classList.add('hidden');
                        statusMessage.textContent = 'Compass Active.';
                        statusMessage.classList.remove('text-red-400', 'hidden');
                        statusMessage.classList.add('text-green-400');
                    }
                } else {
                    statusMessage.textContent = 'Device Orientation not supported on this device.';
                    statusMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error enabling compass:", error);
                statusMessage.textContent = 'Error: Compass features failed to start.';
                statusMessage.classList.remove('hidden');
                enableButton.disabled = false;
            }
        }

        // Attach the enable function to the button click
        document.getElementById('enable-button').addEventListener('click', enableCompass);

        // Initial setup for status message visibility if no permission is needed
        if (typeof DeviceOrientationEvent.requestPermission !== 'function') {
            document.getElementById('status-message').textContent = 'Click to start compass.';
            document.getElementById('status-message').classList.remove('hidden');
            document.getElementById('enable-button').disabled = false;
        } else {
            document.getElementById('status-message').textContent = 'Click "Enable" to request sensor access.';
            document.getElementById('status-message').classList.remove('hidden');
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced GPS Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        .header-bar {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .location-bubble {
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
        }
        .data-point {
            @apply flex-1 text-center border-r border-indigo-200 last:border-r-0 px-2 sm:px-4;
        }
    </style>
</head>
<body class="p-4 sm:p-6">

    <!-- Header Bar -->
    <header id="header-bar" class="fixed top-0 left-0 right-0 bg-indigo-700 text-white p-4 z-10">
        <h1 class="text-xl font-bold tracking-tight">Real-Time Navigation System</h1>
    </header>

    <main class="mt-20">
        <!-- Live Location/Heading Bubble -->
        <div id="location-bubble" class="location-bubble bg-white text-indigo-800 p-4 rounded-xl mb-6 ring-4 ring-indigo-500/50">
            <p class="text-sm font-semibold mb-1 text-indigo-500">CURRENT STATUS</p>
            <div id="status-display" class="flex flex-wrap items-center justify-between text-lg font-bold">
                <!-- Location, Speed, and Heading will be inserted here by JS -->
                <span class="data-point">Lat/Lon: Loading...</span>
                <span class="data-point">Speed: 0.0 kph</span>
                <span class="data-point">Heading: N/A</span>
            </div>
        </div>

        <!-- Quick Change (Destination) Dropdown -->
        <div class="mb-8">
            <button id="toggle-quick-change" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-md transition duration-150 ease-in-out flex justify-between items-center" onclick="toggleQuickChange()">
                <span>Quick Change Destination</span>
                <svg id="dropdown-icon" class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>

            <!-- Destination Inputs (Hidden by default) -->
            <div id="quick-change-content" class="hidden bg-white p-6 rounded-xl shadow-lg mt-2 space-y-4">
                <p class="text-indigo-700 font-medium">Set a New Destination</p>
                <div>
                    <label for="latitudeInput" class="block text-sm font-medium text-gray-700">Latitude</label>
                    <input type="number" id="latitudeInput" placeholder="e.g., 35.78" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="longitudeInput" class="block text-sm font-medium text-gray-700">Longitude</label>
                    <input type="number" id="longitudeInput" placeholder="e.g., -78.64" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button onclick="setDestination()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition duration-150 ease-in-out">
                    Set Destination
                </button>
            </div>
        </div>
        
        <!-- Navigation Display -->
        <div class="bg-indigo-100 p-6 rounded-xl shadow-inner border-t-4 border-indigo-500">
            <h2 class="text-xl font-bold text-indigo-800 mb-4">Navigation Status</h2>
            <div id="navigation-display" class="text-gray-600 space-y-2">
                <p>Destination: <span id="dest-coords" class="font-semibold text-indigo-600">Not Set</span></p>
                <p>Distance to Destination: <span id="distance-display" class="font-semibold">N/A</span></p>
                <p>Time Remaining (Est.): <span id="time-display" class="font-semibold">N/A</span></p>
            </div>
        </div>

        <!-- Message/Error Box -->
        <div id="message-box" class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 bg-red-100 border-l-4 border-red-500 text-red-700 text-sm"></div>

    </main>

    <script>
        // Global variables for destination and position
        let currentPosition = null;
        let destination = null;
        let watchId = null;

        // --- Utility Functions ---

        /**
         * Converts numeric heading (0-360) to 8-point cardinal abbreviation.
         * @param {number} heading - The current heading in degrees.
         * @returns {string} - The abbreviation (N, NE, E, SE, S, SW, W, NW).
         */
        function getDirectionAbbreviation(heading) {
            if (heading === null || heading === undefined) return 'N/A';
            // Round to the nearest 45 degree sector (45 / 2 = 22.5)
            const index = Math.round(heading / 45) % 8; 
            const cardinalDirections = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
            return cardinalDirections[index];
        }

        /**
         * Calculates the distance between two geographical points using the Haversine formula.
         * @param {number} lat1, lon1 - Coordinates of point 1 (current).
         * @param {number} lat2, lon2 - Coordinates of point 2 (destination).
         * @returns {number} Distance in kilometers.
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // --- UI Logic ---

        function showMessage(message, isError = false) {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl transition-opacity duration-300 text-sm ${
                isError ? 'bg-red-100 border-l-4 border-red-500 text-red-700' : 'bg-green-100 border-l-4 border-green-500 text-green-700'
            }`;
            box.style.display = 'block';
            setTimeout(() => {
                box.style.display = 'none';
            }, 5000);
        }

        function toggleQuickChange() {
            const content = document.getElementById('quick-change-content');
            const icon = document.getElementById('dropdown-icon');
            const isVisible = content.classList.contains('hidden');

            if (isVisible) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function setDestination() {
            const lat = parseFloat(document.getElementById('latitudeInput').value);
            const lon = parseFloat(document.getElementById('longitudeInput').value);

            if (isNaN(lat) || isNaN(lon)) {
                showMessage("Please enter valid latitude and longitude values.", true);
                return;
            }

            destination = { lat, lon };
            document.getElementById('dest-coords').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
            showMessage("Destination set successfully!");
            toggleQuickChange(); // Close dropdown after setting

            // Immediately update navigation display with new destination
            if (currentPosition) {
                updateNavigationDisplay(currentPosition);
            }
        }

        // --- Geolocation Handlers ---

        function updateLocationDisplay(position) {
            const lat = position.coords.latitude.toFixed(4);
            const lon = position.coords.longitude.toFixed(4);
            // Speed in meters/sec, convert to km/h (m/s * 3.6)
            const speed = (position.coords.speed !== null ? position.coords.speed * 3.6 : 0).toFixed(1);
            const heading = position.coords.heading !== null ? position.coords.heading.toFixed(0) : 'N/A';
            const directionAbbr = getDirectionAbbreviation(position.coords.heading);
            
            const statusDisplay = document.getElementById('status-display');
            
            // Format for single-line responsive display
            statusDisplay.innerHTML = `
                <span class="data-point">Lat/Lon: ${lat}, ${lon}</span>
                <span class="data-point">Speed: ${speed} kph</span>
                <span class="data-point">Heading: ${heading}Â° (${directionAbbr})</span>
            `;

            currentPosition = position;
            if (destination) {
                updateNavigationDisplay(position);
            }
        }

        function updateNavigationDisplay(position) {
            if (!destination) return;

            const currentLat = position.coords.latitude;
            const currentLon = position.coords.longitude;
            const speedKPH = position.coords.speed !== null ? position.coords.speed * 3.6 : 10; // Use minimum 10 kph for ETA
            
            const distanceKM = calculateDistance(currentLat, currentLon, destination.lat, destination.lon);
            
            document.getElementById('distance-display').textContent = `${distanceKM.toFixed(2)} km`;

            if (speedKPH > 0.5) {
                // Time in hours * 60 minutes/hour
                const timeInMinutes = (distanceKM / speedKPH) * 60;
                const hours = Math.floor(timeInMinutes / 60);
                const minutes = Math.floor(timeInMinutes % 60);
                document.getElementById('time-display').textContent = `${hours}h ${minutes}m (Est.)`;
            } else {
                 document.getElementById('time-display').textContent = `Moving slow or stopped. Distance only.`;
            }
        }

        function handleError(error) {
            let message;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Location access denied. Please enable GPS.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    message = "The request to get user location timed out.";
                    break;
                default:
                    message = "An unknown error occurred while retrieving location.";
            }
            showMessage(`GPS Error: ${message}`, true);
            console.error(error);
        }

        function initGeolocation() {
            if (navigator.geolocation) {
                // Set high accuracy and enable monitoring of heading and speed
                const options = {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000 
                };
                watchId = navigator.geolocation.watchPosition(updateLocationDisplay, handleError, options);
                showMessage("GPS Tracking Started.", false);
            } else {
                showMessage("Geolocation is not supported by this browser.", true);
            }
        }

        window.onload = initGeolocation;
    </script>
</body>
</html>
